{"name": "rabbitmqFacadeSearch", "type": "text/javascript", "context": "provisioning", "source": "// Scripted REST: SEARCH / QUERY script\n// Purpose: poll facade and return event objects for reconciliation\n\nvar baseUrl = configuration.facadeBaseUrl;     // e.g. \"https://facade.example.com\"\nvar apiKey  = configuration.facadeApiKey;\nvar limit   = configuration.limit || 100;\nvar lease   = configuration.leaseSeconds || 60;\n\nfunction http(method, path, body) {\n  var req = {\n    method: method,\n    uri: baseUrl + path,\n    headers: {\n      \"Content-Type\": \"application/json\",\n      \"X-API-Key\": apiKey\n    }\n  };\n  if (body !== null && body !== undefined) {\n    req.entity = JSON.stringify(body);\n  }\n\n  var resp = request(req);\n\n  if (resp.status === 204) {\n    return { status: 204, json: null };\n  }\n  if (resp.status < 200 || resp.status >= 300) {\n    throw \"HTTP \" + resp.status + \" calling \" + path + \" body=\" + (resp.entity || \"\");\n  }\n  return { status: resp.status, json: resp.entity ? JSON.parse(resp.entity) : null };\n}\n\n// Poll facade\nvar poll = http(\"GET\", \"/v1/events/users?limit=\" + limit + \"&leaseSeconds=\" + lease, null);\n\nif (poll.status === 204) {\n  // No results in this cycle\n  // Return an empty list / empty result set (connector framework will accept this)\n  [];\n} else {\n  var batchId = poll.json.batchId;\n  var events = poll.json.events || [];\n\n  // Return “accounts” to IDM\n  // _id MUST be unique; use facade event id (receipt id)\n  var results = events.map(function(evt) {\n    return {\n      _id: evt.id,\n      batchId: batchId,\n      data: evt.data\n    };\n  });\n\n  results;\n}"}